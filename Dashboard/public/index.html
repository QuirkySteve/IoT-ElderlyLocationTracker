<!DOCTYPE html>
<html>

<head>
    <title>MQTT Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .room-container {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }

        #room {
            background-color: lightgray;
            border: 2px solid black;
            position: relative;
            display: flex;
            flex-wrap: wrap;
        }

        .axis-label {
            position: absolute;
            font-weight: bold;
        }

        #x-axis {
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
        }

        #y-axis {
            left: -30px;
            top: 50%;
            transform: translateY(-50%) rotate(-90deg);
        }

        .base-station {
            background-color: red;
            position: absolute;
            cursor: grab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 16px;
        }

        .ble-device {
            background-color: blue;
            position: absolute;
            cursor: pointer;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
    </style>
</head>

<body>
    <h1>MQTT Dashboard</h1>

    <label for="width">Width (m):</label>
    <input type="number" id="width" value="6" min="1">
    <label for="height">Height (m):</label>
    <input type="number" id="height" value="4" min="1">
    <button onclick="updateRoomSize()">Update Room Size</button>

    <div class="container">
        <div class="room-container">
            <span id="x-axis" class="axis-label">6m</span>
            <span id="y-axis" class="axis-label">4m</span>
            <div id="room"></div>
        </div>
    </div>

    <h2>MQTT Messages</h2>
    <ul id="messages"></ul>

    <script>
        const room = document.getElementById("room");
        const SCALE = 50;
        let widthMeters = parseInt(document.getElementById("width").value);
        let heightMeters = parseInt(document.getElementById("height").value);

        class KalmanFilter {
            constructor(R = 0.01, Q = 1) {
                this.R = R; // Process noise
                this.Q = Q; // Measurement noise
                this.A = 1; // State transition
                this.B = 0; // Control input
                this.C = 1; // Measurement mapping
                this.cov = NaN;
                this.x = NaN;
            }

            filter(z) {
                if (isNaN(this.x)) {
                    this.x = z;
                    this.cov = 1;
                } else {
                    let predX = this.A * this.x;
                    let predCov = this.A * this.cov * this.A + this.Q;

                    let K = predCov * this.C / (this.C * predCov * this.C + this.R);
                    this.x = predX + K * (z - this.C * predX);
                    this.cov = (1 - K * this.C) * predCov;
                }
                return this.x;
            }
        }

        // Initialize Kalman Filter instance
        const kalman = new KalmanFilter();

        function updateRoomSize() {
            widthMeters = parseInt(document.getElementById("width").value);
            heightMeters = parseInt(document.getElementById("height").value);
            room.style.width = `${widthMeters * SCALE}px`;
            room.style.height = `${heightMeters * SCALE}px`;
            document.getElementById("x-axis").textContent = `${widthMeters}m`;
            document.getElementById("y-axis").textContent = `${heightMeters}m`;
            addStaticBaseStations();
        }

        function addStaticBaseStations() {
            room.innerHTML = "";
            const positions = [
                { id: 1, x: 0, y: 0 },
                { id: 2, x: (widthMeters - 1) * SCALE, y: 0 },
                { id: 3, x: (widthMeters / 2) * SCALE, y: (heightMeters / 2) * SCALE },
                { id: 4, x: 0, y: (heightMeters - 1) * SCALE },
                { id: 5, x: (widthMeters - 1) * SCALE, y: (heightMeters - 1) * SCALE }
            ];

            positions.forEach(pos => {
                const baseStation = document.createElement("div");
                baseStation.classList.add("base-station");
                baseStation.textContent = pos.id;
                baseStation.style.left = `${pos.x}px`;
                baseStation.style.top = `${pos.y}px`;
                room.appendChild(baseStation);
            });
        }

        // Add a method to visualize the BLE device based on distance
        function updateBleDevicePosition(anchorData) {
            const bleDevice = document.getElementById("ble-device");
            if (!bleDevice) {
                const newDevice = document.createElement("div");
                newDevice.id = "ble-device";
                newDevice.classList.add("ble-device");
                newDevice.textContent = 'Joel';
                room.appendChild(newDevice);
            }

            // Apply Kalman filter to smooth distance readings
            const filteredDistance = kalman.filter(anchorData.distance);

            const xPosition = anchorData.x + (filteredDistance * SCALE);
            const yPosition = anchorData.y + (filteredDistance * SCALE);

            const bleDeviceElement = document.getElementById("ble-device");
            bleDeviceElement.style.left = `${xPosition}px`;
            bleDeviceElement.style.top = `${yPosition}px`;
        }

        updateRoomSize();

        const ws = new WebSocket("ws://localhost:3000");
        ws.onopen = () => console.log("WebSocket connected");
        const MAX_MESSAGES = 5;
        const messageList = document.getElementById("messages");
        let messages = [];

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            const listItem = document.createElement("li");
            listItem.textContent = `Topic: ble/anchor/${data.anchorId}, Message: ${data.message}`;

            // Add the new message to the array
            messages.push(listItem);

            // Keep only the most recent 5 messages
            if (messages.length > MAX_MESSAGES) {
                messageList.removeChild(messages.shift()); // Remove the oldest message
            }

            // Append the new message to the list
            messageList.appendChild(listItem);

            // Extract the distance data from the message
            const match = data.message.match(/Distance: ([0-9.]+) meters/);
            if (match) {
                const distance = parseFloat(match[1]);
                const anchorId = data.anchorId;

                // Set the anchor positions
                const anchorPositions = {
                    1: { x: 0, y: 0 },
                    2: { x: (widthMeters - 1) * SCALE, y: 0 },
                    3: { x: (widthMeters / 2) * SCALE, y: (heightMeters / 2) * SCALE },
                    4: { x: 0, y: (heightMeters - 1) * SCALE },
                    5: { x: (widthMeters - 1) * SCALE, y: (heightMeters - 1) * SCALE }
                };

                if (anchorPositions[anchorId]) {
                    updateBleDevicePosition({ ...anchorPositions[anchorId], distance });
                }
            }
        };

        ws.onclose = () => console.log("WebSocket disconnected");
    </script>
</body>

</html>