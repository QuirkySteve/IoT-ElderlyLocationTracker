<!DOCTYPE html>
<html>
<head>
  <title>Location Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .room-container {
      position: relative;
      margin-top: 20px;
    }
    .axis-label {
      position: absolute;
      font-weight: bold;
    }
    #x-axis {
      top: -25px;
      left: 50%;
      transform: translateX(-50%);
    }
    #y-axis {
      left: -30px;
      top: 50%;
      transform: translateY(-50%) rotate(-90deg);
    }
    .base-station {
      background-color: red;
      position: absolute;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .ble-device {
      background-color: blue;
      position: absolute;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    .tables-container {
      display: flex;
      justify-content: space-around;
      width: 100%;
      margin-top: 40px;
      gap: 20px;
    }
    .status-table {
      border: 1px solid #ccc;
      padding: 10px;
      min-width: 200px;
    }
    .status-table h2 {
      margin: 0 0 10px 0;
      text-align: center;
    }
    .status-indicator {
      text-align: center;
      padding: 5px;
      margin: 5px 0;
    }
    .present {
      background-color: #e6f4ea;
    }
    .absent {
      background-color: #fce8e6;
    }
    #room-test {
      background-color: lightgray;
      border: 2px solid black;
      position: relative;
      background-image: linear-gradient(to right, grey 1px, transparent 1px), linear-gradient(to bottom, grey 1px, transparent 1px);
      background-size: 300px 300px; /* 5m grid = one square */
    }
  </style>
</head>
<body>
  <h1>Real-Time User Location</h1>

  <div class="container">
    <div class="tables-container">
      <div class="status-table">
        <h2>Room D</h2>
        <div id="room1-status" class="status-indicator absent">Not Present</div>
        <div>RSSI: <span id="room1-rssi">--</span> dBm</div>
        <div>Last Update: <span id="room1-time">Never</span></div>
      </div>

      <div class="status-table">
        <h2>Room E</h2>
        <div id="room2-status" class="status-indicator absent">Not Present</div>
        <div>RSSI: <span id="room2-rssi">--</span> dBm</div>
        <div>Last Update: <span id="room2-time">Never</span></div>
      </div>

      <div class="status-table">
        <h2>Out of Facility</h2>
        <div id="out-status" class="status-indicator absent">Not Present</div>
        <div>RSSI: <span id="out-rssi">--</span> dBm</div>
        <div>Last Update: <span id="out-time">Never</span></div>
      </div>
    </div>

    <hr style="margin: 40px 0;">

    <h2>Room Space (5m x 5m)</h2>
    <div class="container">
       <div class="room-container">
         <span id="x-axis-test" class="axis-label">5m</span>
         <span id="y-axis-test" class="axis-label">5m</span>
         <div id="room-test"></div>
       </div>
     </div>
  </div>

  <script>
    let isUserPresent = false;

    const roomTest = document.getElementById("room-test");
    const SCALE_TEST = 60; // 1m = 60px
    const testWidthMeters = 5;
    const testHeightMeters = 5;

    function setupTestRoom() {
        roomTest.style.width = `${testWidthMeters * SCALE_TEST}px`;
        roomTest.style.height = `${testHeightMeters * SCALE_TEST}px`;
        document.getElementById("x-axis-test").textContent = `${testWidthMeters}m`;
        document.getElementById("y-axis-test").textContent = `${testHeightMeters}m`;
        addStaticBaseStationsTest();
    }

    function addStaticBaseStationsTest() {
        roomTest.innerHTML = "";
        const positions = [
            { id: 1, x: 0, y: 5 },
            { id: 2, x: 5, y: 5 },
            { id: 3, x: 2.5, y: 0 }
        ];
        positions.forEach(pos => {
            const baseStation = document.createElement("div");
            baseStation.classList.add("base-station");
            baseStation.textContent = pos.id;
            const xPx = pos.x * SCALE_TEST;
            const yPx = (testHeightMeters - pos.y) * SCALE_TEST;
            baseStation.style.left = `${xPx - 25}px`;
            baseStation.style.top = `${yPx - 25}px`;
            roomTest.appendChild(baseStation);
        });
    }

    function updateUserPositionTest(xMeters, yMeters) {
        let userDot = document.getElementById("ble-device-test");
        if (!userDot) {
            userDot = document.createElement("div");
            userDot.id = "ble-device-test";
            userDot.classList.add("ble-device");
            userDot.textContent = "U";
            roomTest.appendChild(userDot);
        }

        // Clamp position within 0â€“5m to prevent overflow beyond grid
        const xClamped = Math.max(0, Math.min(testWidthMeters, xMeters));
        const yClamped = Math.max(0, Math.min(testHeightMeters, yMeters));

        const xPx = xMeters * SCALE_TEST;
        const yPx = (testHeightMeters - yMeters) * SCALE_TEST;
        userDot.style.left = `${xPx - 15}px`;
        userDot.style.top = `${yPx - 15}px`;
    }

    const OUT_OF_FACILITY_THRESHOLD = -90;
    const latestRSSI = { room1: null, room2: null };

    function updateAllRoomStatuses() {
        if (Object.values(latestRSSI).every(rssi => rssi === null || rssi < OUT_OF_FACILITY_THRESHOLD)) {
            updateRoomStatus('room1', latestRSSI.room1, false);
            updateRoomStatus('room2', latestRSSI.room2, false);
            updateRoomStatus('out', Math.min(...Object.values(latestRSSI).filter(v => v !== null)), true);
            return;
        }

        let strongestRSSI = -Infinity;
        let strongestRoom = null;

        for (const [room, rssi] of Object.entries(latestRSSI)) {
            if (rssi !== null && rssi > strongestRSSI && rssi >= OUT_OF_FACILITY_THRESHOLD) {
                strongestRSSI = rssi;
                strongestRoom = room;
            }
        }

        updateRoomStatus('room1', latestRSSI.room1, strongestRoom === 'room1');
        updateRoomStatus('room2', latestRSSI.room2, strongestRoom === 'room2');
        updateRoomStatus('out', Math.min(...Object.values(latestRSSI).filter(v => v !== null)), strongestRoom === null);

        if ((latestRSSI.room1 === null && latestRSSI.room2 === null) ||
            (latestRSSI.room1 < OUT_OF_FACILITY_THRESHOLD && latestRSSI.room2 < OUT_OF_FACILITY_THRESHOLD)) {
            isUserPresent = false;
        }
    }

    function updateRoomStatus(roomId, rssi, isPresent) {
        const statusElement = document.getElementById(`${roomId}-status`);
        const rssiElement = document.getElementById(`${roomId}-rssi`);
        const timeElement = document.getElementById(`${roomId}-time`);
        if (rssi !== null) {
            rssiElement.textContent = rssi;
            timeElement.textContent = new Date().toLocaleTimeString();
        }
        statusElement.textContent = isPresent ? "Present" : "Not Present";
        statusElement.className = "status-indicator " + (isPresent ? "present" : "absent");
    }

    setupTestRoom();

    const ws = new WebSocket("ws://localhost:3000");
    ws.onopen = () => console.log("WebSocket connected");

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.position) {
            const { x, y } = data.position;
            if (isUserPresent) {
                updateUserPositionTest(x, y);
            } else {
                const userDot = document.getElementById("ble-device-test");
                if (userDot) userDot.remove();
            }
            return;
        }

        if (data.type === 'lora') {
            const { sender, rssi } = data;
            isUserPresent = true;

            if (sender === 'D') {
                latestRSSI.room1 = rssi;
            } else if (sender === 'E') {
                latestRSSI.room2 = rssi;
            }

            updateAllRoomStatuses();
        }
    };

    ws.onclose = () => console.log("WebSocket disconnected");
  </script>
</body>
</html>
